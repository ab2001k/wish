<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WishMaker - Premium</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÅ</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Pacifico&display=swap');

        body { font-family: 'Poppins', sans-serif; overflow-x: hidden; background-color: #f3f4f6; }
        .handwritten { font-family: 'Pacifico', cursive; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animations */
        .gift-box-anim { animation: shake 2.5s infinite ease-in-out; cursor: pointer; transition: transform 0.2s; }
        .gift-box-anim:active { transform: scale(0.95); }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Themes */
        .theme-male { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .theme-female { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .theme-wedding { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .theme-kid { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); } 

        /* History Item */
        .history-item { transition: all 0.2s; }
        .history-item:active { transform: scale(0.98); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 sm:p-4">

    <div id="app-container" class="bg-white w-full sm:max-w-md h-screen sm:h-[850px] sm:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col">
        
        <audio id="audio-bg" loop></audio>

        <div id="screen-loading" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center hidden-screen">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 font-bold">Loading Magic...</p>
        </div>

        <div id="screen-home" class="flex-1 flex flex-col p-6 fade-in relative overflow-y-auto bg-gray-50 scrollbar-hide">
            
            <div class="text-center mb-6 mt-4">
                <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Wish<span class="text-indigo-600">Maker</span></h1>
                <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Create & Share Moments</p>
            </div>

            <div class="space-y-4">
                <button onclick="selectType('birthday')" id="btn-birthday" class="w-full bg-white p-6 rounded-2xl shadow-md border-2 border-transparent hover:border-pink-400 hover:shadow-xl transition transform active:scale-95 flex items-center gap-4 group text-left">
                    <div class="bg-pink-100 p-4 rounded-full text-3xl group-hover:rotate-12 transition">üéÇ</div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Birthday Wish</h3>
                        <p class="text-xs text-gray-500">For friends, family & fun</p>
                    </div>
                </button>

                <button onclick="selectType('wedding')" id="btn-wedding" class="w-full bg-white p-6 rounded-2xl shadow-md border-2 border-transparent hover:border-purple-400 hover:shadow-xl transition transform active:scale-95 flex items-center gap-4 group text-left">
                    <div class="bg-purple-100 p-4 rounded-full text-3xl group-hover:rotate-12 transition">üíç</div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Wedding / Anniversary</h3>
                        <p class="text-xs text-gray-500">For love & celebrations</p>
                    </div>
                </button>
            </div>

            <div id="history-section" class="mt-8 hidden-screen">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Your Past Wishes</h3>
                    <span class="text-xs text-indigo-500 font-semibold cursor-pointer" onclick="clearHistory()">Clear All</span>
                </div>
                <div id="history-list" class="space-y-3 pb-20">
                    </div>
            </div>

            <div id="creator-form" class="fixed inset-0 bg-white z-40 p-6 flex flex-col hidden-screen overflow-y-auto">
                <div class="flex items-center mb-6">
                    <button onclick="closeForm()" class="p-2 rounded-full bg-gray-100 text-gray-600"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-xl font-bold ml-4">Enter Details</h2>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                    <label class="text-xs font-bold text-gray-400 uppercase">Select Theme</label>
                    <div class="flex gap-3 mt-2 mb-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="gender" value="male" class="peer hidden" onchange="updateThemePreview('male')" checked>
                            <div class="py-2 px-3 rounded-lg border border-gray-200 text-sm font-bold text-center text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition">
                                üë® Male
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="gender" value="female" class="peer hidden" onchange="updateThemePreview('female')">
                            <div class="py-2 px-3 rounded-lg border border-gray-200 text-sm font-bold text-center text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-pink-500 transition">
                                üë© Female
                            </div>
                        </label>
                    </div>

                    <input type="text" id="inp-name" placeholder="Recipient Name" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500 mb-3 text-sm font-semibold">
                    
                    <div class="flex gap-3 mb-3">
                        <div class="w-1/3">
                            <input type="number" id="inp-age" placeholder="Age" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none text-sm font-semibold">
                        </div>
                        <div class="w-2/3">
                            <select id="inp-relation" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none text-sm font-semibold text-gray-600">
                                <option value="friend">Friend</option>
                                <option value="family">Family/Elder</option>
                                <option value="spouse">Spouse/Partner</option>
                                <option value="child">Son/Daughter</option>
                                <option value="sibling">Brother/Sister</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 border-t border-gray-100 pt-3">
                        <div class="w-12 h-12 rounded-full bg-gray-100 overflow-hidden relative border border-gray-300">
                            <img id="preview-thumb" class="w-full h-full object-cover hidden">
                            <i class="fas fa-camera absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        </div>
                        <label class="flex-1 bg-gray-800 hover:bg-black text-white py-2 rounded-lg text-xs font-bold uppercase tracking-wide cursor-pointer text-center transition">
                            Upload Photo
                            <input type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                        </label>
                    </div>
                </div>

                <button onclick="saveAndGenerate()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 transform transition hover:scale-[1.02] flex justify-center items-center gap-2">
                    Generate Wish Link <i class="fas fa-wand-magic-sparkles"></i>
                </button>
            </div>
        </div>

        <div id="screen-reveal" class="flex-1 hidden-screen flex flex-col items-center justify-center bg-gray-900 text-white relative overflow-hidden">
            <div id="reveal-icons" class="absolute inset-0 pointer-events-none opacity-50"></div> 
            
            <h2 class="text-3xl font-bold mb-10 animate-pulse text-center leading-tight">A Special Surprise<br><span class="text-lg font-normal text-gray-300">is waiting for you!</span></h2>
            <div class="gift-box-anim text-9xl relative z-10" onclick="openWish()">üéÅ</div>
            <p class="mt-10 text-xs uppercase tracking-widest text-gray-500 font-bold">Tap the gift</p>
        </div>

        <div id="screen-display" class="flex-1 hidden-screen flex flex-col relative overflow-hidden transition-all duration-1000">
            
            <div class="absolute top-4 left-4 z-30 flex gap-2">
                <button onclick="window.location.href = window.location.pathname" class="bg-white/40 backdrop-blur p-2 rounded-full text-gray-800 text-xs font-bold px-3 shadow-sm">
                    <i class="fas fa-plus"></i> Home
                </button>
            </div>
            
            <div class="absolute top-4 right-4 z-30 flex gap-2">
                <button id="btn-delete" onclick="deleteWish()" class="hidden bg-red-500 text-white p-2 w-8 h-8 rounded-full shadow-lg">
                    <i class="fas fa-trash text-xs"></i>
                </button>
                <button onclick="toggleAudio()" class="bg-white/40 backdrop-blur p-2 w-8 h-8 rounded-full text-gray-800 shadow-sm">
                    <i id="icon-audio" class="fas fa-volume-up text-xs"></i>
                </button>
            </div>

            <div id="capture-area" class="flex-1 flex flex-col items-center justify-center p-6 text-center z-10 pt-16">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-white/40 rounded-full blur-2xl animate-pulse"></div>
                    <img id="disp-img" src="" class="w-44 h-44 rounded-full border-4 border-white shadow-2xl object-cover relative z-10 animate-[float_6s_infinite]">
                    <div id="disp-age-badge" class="absolute bottom-2 right-0 bg-yellow-400 text-yellow-900 font-extrabold w-12 h-12 flex items-center justify-center rounded-full shadow-lg border-4 border-white rotate-12 z-20 text-lg hidden"></div>
                </div>

                <h1 id="disp-title" class="text-4xl font-extrabold text-white mb-1 drop-shadow-md tracking-tight"></h1>
                <h2 id="disp-name" class="text-3xl text-white mb-6 handwritten drop-shadow-md"></h2>

                <div class="bg-white/90 backdrop-blur-xl p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-white/50">
                    <i class="fas fa-quote-left text-indigo-200 text-2xl absolute top-4 left-4"></i>
                    <p id="disp-msg" class="text-gray-800 text-sm sm:text-base font-medium leading-relaxed mt-2"></p>
                    <i class="fas fa-quote-right text-indigo-200 text-2xl absolute bottom-4 right-4"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-20 relative">
                <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-4"></div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="shareWhatsapp()" class="bg-[#25D366] text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 text-sm hover:opacity-90">
                        <i class="fab fa-whatsapp text-lg"></i> Send Link
                    </button>
                    <button onclick="downloadImage()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 text-sm hover:opacity-90">
                        <i class="fab fa-instagram text-lg"></i> Save Img
                    </button>
                </div>
                
                <button onclick="copyLink()" class="w-full text-gray-400 py-2 text-xs font-bold uppercase tracking-widest hover:text-gray-600">
                    Copy Link to Clipboard
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://rhodybetonjerkcsdstj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJob2R5YmV0b25qZXJrY3Nkc3RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTU5MDAsImV4cCI6MjA4NDQ3MTkwMH0.IEO-2spCVUxYFiQW-ARlA4RH57R_DQttQsWW0tGnUMI';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentWishId = null;
        let wishData = { type: '', gender: 'male', image: null };
        const audioBirthday = "https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3";
        const audioWedding = "https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3";
        
        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (id) {
                // VIEWER MODE
                document.getElementById('screen-home').classList.add('hidden-screen');
                document.getElementById('screen-loading').classList.remove('hidden-screen');
                await fetchAndLoadWish(id);
            } else {
                // CREATOR MODE
                loadHistory(); // Load previous wishes
            }
        };

        // ==========================================
        // 3. CREATOR LOGIC & HISTORY
        // ==========================================
        function selectType(type) {
            wishData.type = type;
            document.getElementById('creator-form').classList.remove('hidden-screen');
        }

        function closeForm() {
            document.getElementById('creator-form').classList.add('hidden-screen');
        }

        function updateThemePreview(gender) {
            wishData.gender = gender;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    wishData.image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-thumb').src = wishData.image;
                    document.getElementById('preview-thumb').classList.remove('hidden');
                };
            };
            reader.readAsDataURL(file);
        }

        async function saveAndGenerate() {
            const name = document.getElementById('inp-name').value;
            const age = document.getElementById('inp-age').value;
            const relation = document.getElementById('inp-relation').value;
            
            if(!name) return alert("Please enter a name!");

            // Determine Theme
            let themeClass = 'theme-male';
            if(wishData.type === 'wedding') themeClass = 'theme-wedding';
            else if(age && age < 13) themeClass = 'theme-kid';
            else if(wishData.gender === 'female') themeClass = 'theme-female';

            const msg = generateLongMessage(wishData.type, relation, name, age);
            document.getElementById('screen-loading').classList.remove('hidden-screen');

            // 1. SAVE TO DB
            const { data, error } = await client.from('wishes').insert([{ 
                type: wishData.type, name: name, message: msg, image_data: wishData.image, 
                gender: wishData.gender, age: age, theme: themeClass
            }]).select();

            if(error) {
                console.error(error);
                alert("Error saving! Note: Images must be small.");
                document.getElementById('screen-loading').classList.add('hidden-screen');
                return;
            }

            const newId = data[0].id;

            // 2. SAVE TO LOCAL HISTORY
            addToHistory(newId, name, wishData.type);

            window.location.href = `?id=${newId}`;
        }

        // HISTORY FUNCTIONS
        function addToHistory(id, name, type) {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            history.unshift({ id, name, type, date: new Date().toLocaleDateString() });
            localStorage.setItem('wish_history', JSON.stringify(history));
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            const list = document.getElementById('history-list');
            const section = document.getElementById('history-section');
            
            if (history.length === 0) {
                section.classList.add('hidden-screen');
                return;
            }

            section.classList.remove('hidden-screen');
            list.innerHTML = '';

            history.forEach(item => {
                const icon = item.type === 'birthday' ? 'üéÇ' : 'üíç';
                const div = document.createElement('div');
                div.className = 'history-item bg-white p-3 rounded-xl border border-gray-200 flex items-center justify-between shadow-sm';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl bg-gray-100 p-2 rounded-lg">${icon}</span>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${item.name}</p>
                            <p class="text-[10px] text-gray-400">${item.date}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyHistoryLink('${item.id}')" class="text-gray-400 hover:text-indigo-600 p-2"><i class="fas fa-copy"></i></button>
                        <a href="?id=${item.id}" class="bg-indigo-600 text-white text-xs font-bold px-3 py-2 rounded-lg">View</a>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function copyHistoryLink(id) {
            const link = window.location.origin + window.location.pathname + '?id=' + id;
            navigator.clipboard.writeText(link).then(() => alert("Link Copied!"));
        }

        function clearHistory() {
            if(confirm("Clear history? (This won't delete the actual wishes, just this list)")) {
                localStorage.removeItem('wish_history');
                location.reload();
            }
        }

        function removeFromHistory(id) {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('wish_history', JSON.stringify(history));
        }

        // ==========================================
        // 4. VIEWER LOGIC
        // ==========================================
        async function fetchAndLoadWish(id) {
            currentWishId = id;
            const { data, error } = await client.from('wishes').select('*').eq('id', id).single();

            if(error || !data) {
                // If not found in DB, remove from history too
                removeFromHistory(id);
                alert("Wish not found or deleted!");
                window.location.href = window.location.pathname;
                return;
            }

            // Populate UI
            document.getElementById('disp-img').src = data.image_data || (data.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
            document.getElementById('disp-title').innerText = data.type === 'birthday' ? "Happy Birthday!" : "Happy Anniversary!";
            document.getElementById('disp-name').innerText = data.name;
            document.getElementById('disp-msg').innerText = data.message;
            document.getElementById('screen-display').className = `flex-1 hidden-screen flex flex-col relative overflow-hidden transition-all duration-1000 ${data.theme}`;

            if(data.age && data.type === 'birthday') {
                const badge = document.getElementById('disp-age-badge');
                badge.innerText = data.age;
                badge.classList.remove('hidden');
            }

            // Check Ownership via History
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            const isOwner = history.some(item => item.id === id);
            
            if(isOwner) {
                document.getElementById('btn-delete').classList.remove('hidden');
            }

            document.getElementById('audio-bg').src = data.type === 'birthday' ? audioBirthday : audioWedding;
            setupFloatingIcons(data.age, data.gender, data.type);

            document.getElementById('screen-loading').classList.add('hidden-screen');
            document.getElementById('screen-reveal').classList.remove('hidden-screen');
        }

        function openWish() {
            document.getElementById('screen-reveal').classList.add('hidden-screen');
            document.getElementById('screen-display').classList.remove('hidden-screen');
            document.getElementById('audio-bg').play().catch(e => console.log("Audio requires tap"));
            fireConfetti();
        }

        async function deleteWish() {
            if(!confirm("Delete this wish permanently?")) return;
            await client.from('wishes').delete().eq('id', currentWishId);
            removeFromHistory(currentWishId); // Also remove from history
            window.location.href = window.location.pathname;
        }

        // ==========================================
        // 5. GENERATOR & UTILS
        // ==========================================
        function generateLongMessage(type, relation, name, age) {
            if (type === 'wedding') {
                return `Happy Anniversary, ${name}! ü•Ç Celebrating the beautiful journey of love you've built together. May your bond grow stronger with every passing year, filled with laughter, joy, and endless memories. Here's to forever! ‚ù§Ô∏è`;
            }
            if (age && age < 13) {
                return `Happy Birthday to our little superstar ${name}! üåü You are turning ${age} today! May your day be filled with toys, cake, balloons, and so much fun. Keep shining bright! üéàüéÇ`;
            }
            const templates = {
                friend: [`Happy Birthday ${name}! üéÇ Another year older, wiser, and even more awesome. So grateful to have a friend like you in my life. Let's make this year the best one yet! Cheers! ü•Ç`, `To my partner in crime, ${name}! üéâ Happy Birthday! Thank you for being such an amazing friend. Wishing you endless happiness, success, and zero stress today!`],
                family: [`Happy Birthday ${name}! ‚ù§Ô∏è Your kindness and strength inspire everyone around you. Wishing you a day filled with the same love you give to others. Blessings always.`, `Dearest ${name}, wishing you the happiest of birthdays! Thank you for being a pillar of our family. May this year bring you great health and joy.`],
                spouse: [`To my everything, ${name}. ‚ù§Ô∏è Happy Birthday! Life is a beautiful adventure with you by my side. I love you more than words can say. Let's celebrate you today!`, `Happy Birthday to my better half, ${name}. üåπ Every day with you is a gift. Wishing you all the happiness in the world today and always.`],
                child: [`Happy Birthday to my wonderful child, ${name}! ‚ù§Ô∏è Watching you grow into such an amazing person is my greatest joy. So proud of you. Have a fantastic birthday!`, `To my dearest ${name}, Happy Birthday! üéÇ You bring so much light into our lives. May all your dreams come true this year!`],
                sibling: [`Happy Birthday ${name}! ü§™ Growing up with you has been a crazy ride, but I wouldn't trade it for anything. Have a blast today!`, `To the best sibling ever, ${name}. Happy Birthday! Thanks for always having my back. Love you!`]
            };
            const cat = templates[relation] || templates['friend'];
            return cat[Math.floor(Math.random() * cat.length)];
        }

        function shareWhatsapp() {
            const text = `Special wish for you! ‚ú® Tap to see: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function downloadImage() {
            const capture = document.getElementById('capture-area'); 
            const watermark = document.createElement('div');
            watermark.innerHTML = "Created with WishMaker";
            watermark.className = "absolute bottom-2 text-white/50 text-xs font-bold w-full text-center z-50";
            capture.appendChild(watermark);

            html2canvas(capture, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                watermark.remove();
                const link = document.createElement('a');
                link.download = `Wish_for_${document.getElementById('disp-name').innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();
                alert("Image Saved! üì∏\nPost this to your Status/Story!");
            });
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => alert("Link Copied!"));
        }

        function setupFloatingIcons(age, gender, type) {
            const container = document.getElementById('reveal-icons');
            let icons = ['‚ú®', 'üéÅ']; 
            if(type === 'birthday') {
                if(age && age < 13) icons = ['üß∏', 'üéà', 'ü¶Ñ', 'üç≠', 'üéÆ'];
                else if (gender === 'female') icons = ['ü¶ã', 'üå∏', 'üßÅ', 'üç∑', '‚ú®'];
                else icons = ['üöÄ', 'üçï', 'üç∫', 'üî•', 'üé∏'];
            } else {
                icons = ['ü•Ç', 'üíç', 'üïäÔ∏è', '‚ù§Ô∏è', 'üåπ'];
            }
            container.innerHTML = '';
            for(let i=0; i<20; i++) {
                const el = document.createElement('div');
                el.innerText = icons[Math.floor(Math.random()*icons.length)];
                el.style.position = 'absolute';
                el.style.left = Math.random() * 100 + '%';
                el.style.top = Math.random() * 100 + '%';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animation = `float ${Math.random()*3 + 2}s infinite ease-in-out`;
                container.appendChild(el);
            }
        }

        function fireConfetti() {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        }

        function toggleAudio() {
            const audio = document.getElementById('audio-bg');
            const icon = document.getElementById('icon-audio');
            if(audio.paused) { audio.play(); icon.className = "fas fa-volume-up"; }
            else { audio.pause(); icon.className = "fas fa-volume-mute"; }
        }
    </script>
</body>
</html>