<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WishMaker - Premium</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÅ</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Typography */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,600;0,800;1,600&family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* For Matrix Mode */

        /* GLOBAL RESET & LAYOUT */
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #000;
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none; -ms-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #app-wrapper {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .handwritten { font-family: 'Pacifico', cursive; }
        .elegant-font { font-family: 'Playfair Display', serif; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animations */
        .gift-box-anim { animation: shake 2.5s infinite ease-in-out; cursor: pointer; transition: transform 0.2s; }
        .gift-box-anim:active { transform: scale(0.95); }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BACKGROUND STYLES --- */
        #bg-layer {
            position: absolute; inset: 0; z-index: 0;
            background-size: cover; background-position: center;
            filter: blur(3px) brightness(0.9);
            transform: scale(1.02); 
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* SHINY AGE BADGE */
        .shiny-badge {
            position: absolute; bottom: 0; right: 0; width: 3.5rem; height: 3.5rem;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-family: 'Playfair Display', serif; font-weight: 800; font-size: 1.25rem;
            border: 3px solid #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 2px 5px rgba(255,255,255,0.4);
            transform: rotate(10deg); z-index: 20;
            line-height: 1; padding-bottom: 2px;
        }

        /* DECORATIVE EMOJIS */
        .deco-emoji {
            position: absolute; font-size: 2.5rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            z-index: 5; animation: float 4s ease-in-out infinite;
        }

        /* Button Click Effect */
        .btn-click:active { transform: scale(0.95); }

        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* MATRIX MODE STYLES */
        #matrix-overlay {
            position: fixed; inset: 0; background: black; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'VT323', monospace;
        }
        canvas#matrix-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .matrix-content { z-index: 50; text-align: center; width: 100%; position: relative; }
        .hacked-title { color: #0f0; font-size: 4rem; margin-bottom: 2rem; text-shadow: 0 0 10px #0f0; animation: zoomIn 5s infinite alternate; }
        #matrix-controls { opacity: 0; transition: opacity 1.5s ease-in; display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        @keyframes zoomIn { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        
        .matrix-btn {
            background: black; color: #0f0; border: 2px solid #0f0; padding: 15px 30px; font-size: 1.5rem; 
            text-transform: uppercase; letter-spacing: 3px; box-shadow: 0 0 15px #0f0;
            animation: blinkMatrix 1s infinite steps(2, start); cursor: pointer; text-decoration: none; 
            display: inline-block; margin-top: 20px; min-width: 250px;
        }
        .matrix-btn-back {
            background: black; color: white; border: 2px solid white; padding: 10px 20px; font-size: 1.2rem;
            text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 10px white; cursor: pointer;
            margin-top: 20px; display: inline-block; min-width: 200px; transition: all 0.3s;
        }
        .matrix-btn-back:hover { background: #222; }
        @keyframes blinkMatrix { 0%, 100% { opacity: 1; box-shadow: 0 0 15px #0f0; } 50% { opacity: 0.8; box-shadow: 0 0 5px #0f0; } }

        /* THEME SELECTOR STYLES */
        .theme-option {
            width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer; border: 3px solid white;
            transition: transform 0.2s, border-color 0.2s;
            flex-shrink: 0;
            background-size: cover; background-position: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .theme-option:hover { transform: scale(1.1); }
        .theme-option.selected { border-color: #6366f1; transform: scale(1.2); box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); }

        /* --- GHOST CURSOR ANIMATIONS --- */
        .ghost-cursor {
            position: absolute; 
            width: 28px; height: 28px; z-index: 100;
            pointer-events: none; 
            filter: drop-shadow(3px 3px 2px rgba(0,0,0,0.4));
            opacity: 0; transform-origin: top left;
            display: none; 
        }

        .anim-move-click { display: block !important; animation: mouseSequence 4.5s ease-in-out forwards; }
        .anim-text-bump { animation: titleBump 4.5s ease-in-out forwards; }
        
        .manual-bump { animation: manualBump 0.2s ease-out forwards !important; }
        @keyframes manualBump {
            0% { transform: scale(1); color: #1f2937; }
            50% { transform: scale(0.9); color: #7c3aed; }
            100% { transform: scale(1); color: #1f2937; }
        }

        .click-ripple {
            position: fixed; width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid rgba(59, 130, 246, 0.8); background: rgba(59, 130, 246, 0.2);
            transform: translate(-50%, -50%) scale(0); pointer-events: none; z-index: 99;
            animation: rippleEffect 0.5s ease-out forwards;
        }
        @keyframes rippleEffect {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        @keyframes mouseSequence {
            0% { left: 150%; top: 150%; opacity: 1; } 
            20% { left: 48%; top: 55%; opacity: 1; } 
            25% { transform: translate(1px, 1px); } 30% { transform: translate(0, 0); }
            40% { transform: translate(1px, 1px); } 45% { transform: translate(0, 0); }
            55% { transform: translate(1px, 1px); } 60% { transform: translate(0, 0); }
            70% { transform: translate(1px, 1px); } 75% { transform: translate(0, 0); }
            85% { left: 48%; top: 55%; opacity: 1; }
            100% { left: -100%; top: -100%; opacity: 0; }
        }

        @keyframes titleBump {
            0%, 23% { transform: scale(1); color: #1f2937; } 
            25% { transform: scale(0.9); color: #4f46e5; } 30% { transform: scale(1); color: #1f2937; }
            40% { transform: scale(0.9); color: #4f46e5; } 45% { transform: scale(1); color: #1f2937; }
            55% { transform: scale(0.9); color: #4f46e5; } 60% { transform: scale(1); color: #1f2937; }
            70% { transform: scale(0.9); color: #4f46e5; } 75% { transform: scale(1); color: #1f2937; }
            100% { transform: scale(1); color: #1f2937; }
        }

        @media (max-height: 800px) {
            #capture-area { padding-top: 1rem !important; padding-bottom: 0.5rem !important; } 
            .photo-frame { width: 8rem !important; height: 8rem !important; } 
            #disp-title { font-size: 1.75rem !important; margin-bottom: 0.25rem !important; }
            #disp-name { font-size: 1.5rem !important; margin-bottom: 0.5rem !important; }
            .glass-panel { padding: 1rem !important; }
            #share-sheet { padding: 0.75rem !important; }
        }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <div id="app-container" class="bg-gray-50/90 backdrop-blur w-full h-[100dvh] sm:max-w-md sm:h-[850px] sm:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col">
            
            <audio id="audio-bg" loop></audio>
            <audio id="audio-matrix" loop src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

            <div id="screen-loading" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center hidden-screen">
                <div class="loader mb-4"></div>
                <p class="text-indigo-600 font-bold tracking-widest text-xs uppercase">Creating Magic...</p>
            </div>

            <div id="matrix-overlay" class="hidden-screen">
                <canvas id="matrix-canvas"></canvas>
                <div class="matrix-content">
                    <h1 class="hacked-title">SYSTEM HACKED</h1>
                    <div id="matrix-controls">
                        <h2 class="text-white text-3xl mb-8">...Just Kidding! üòú</h2>
                        <a href="https://wa.me/+918822967314" class="matrix-btn">> TALK TO DEV_</a>
                        <button onclick="exitMatrix()" class="matrix-btn-back">< GO BACK</button>
                    </div>
                </div>
            </div>

            <div id="screen-home" class="flex-1 flex flex-col p-6 fade-in relative overflow-y-auto bg-white/95 scrollbar-hide">
                <div class="text-center mb-6 mt-6 select-none relative">
                    <div class="relative inline-block">
                        <h1 id="app-title" onclick="triggerEasterEgg()" class="text-5xl font-extrabold text-gray-800 tracking-tighter cursor-pointer select-none transition origin-center">
                            Wish<span class="text-indigo-600">Maker</span>
                        </h1>
                        <img id="ghost-cursor" class="ghost-cursor" src="data:image/svg+xml,%3Csvg width='35' height='35' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.5 3.21429V20.3571L10.5 15.3571H17.6429L5.5 3.21429Z' fill='white' stroke='black' stroke-width='1.5'/%3E%3C/svg%3E" alt="cursor">
                    </div>
                    <p class="text-xs text-gray-400 mt-2 uppercase tracking-[0.2em]">Celebrate Moments</p>
                </div>

                <div class="space-y-4">
                    <button onclick="playClick(); selectType('birthday')" id="btn-birthday" class="btn-click w-full bg-white p-5 rounded-3xl shadow-lg border border-gray-100 hover:border-pink-300 hover:shadow-xl transition flex items-center gap-5 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-pink-50 to-white opacity-0 group-hover:opacity-100 transition duration-500"></div>
                        <div class="bg-pink-100 p-3 rounded-2xl text-3xl group-hover:rotate-12 transition relative z-10">üéÇ</div>
                        <div class="text-left relative z-10">
                            <h3 class="text-lg font-bold text-gray-800">Birthday Wish</h3>
                            <p class="text-[10px] text-gray-500">Friends, family & little ones</p>
                        </div>
                    </button>

                    <button onclick="playClick(); selectType('wedding')" id="btn-wedding" class="btn-click w-full bg-white p-5 rounded-3xl shadow-lg border border-gray-100 hover:border-purple-300 hover:shadow-xl transition flex items-center gap-5 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-purple-50 to-white opacity-0 group-hover:opacity-100 transition duration-500"></div>
                        <div class="bg-purple-100 p-3 rounded-2xl text-3xl group-hover:rotate-12 transition relative z-10">üíç</div>
                        <div class="text-left relative z-10">
                            <h3 class="text-lg font-bold text-gray-800">Anniversary</h3>
                            <p class="text-[10px] text-gray-500">Weddings & couples</p>
                        </div>
                    </button>

                    <div class="mt-6">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="h-[1px] bg-gray-200 flex-1"></div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Indian Festival Pack</span>
                            <div class="h-[1px] bg-gray-200 flex-1"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="playClick(); selectType('diwali')" class="btn-click bg-white p-3 rounded-2xl shadow-sm border border-orange-100 hover:border-orange-400 flex flex-col items-center gap-2">
                                <span class="text-2xl">ü™î</span> <span class="text-xs font-bold text-gray-700">Diwali</span>
                            </button>
                            <button onclick="playClick(); selectType('holi')" class="btn-click bg-white p-3 rounded-2xl shadow-sm border border-pink-100 hover:border-pink-400 flex flex-col items-center gap-2">
                                <span class="text-2xl">üé®</span> <span class="text-xs font-bold text-gray-700">Holi</span>
                            </button>
                            <button onclick="playClick(); selectType('ganesha')" class="btn-click bg-white p-3 rounded-2xl shadow-sm border border-yellow-100 hover:border-yellow-400 flex flex-col items-center gap-2">
                                <span class="text-2xl">üêò</span> <span class="text-xs font-bold text-gray-700">Ganesha</span>
                            </button>
                            <button onclick="playClick(); selectType('durga')" class="btn-click bg-white p-3 rounded-2xl shadow-sm border border-red-100 hover:border-red-400 flex flex-col items-center gap-2">
                                <span class="text-2xl">üî±</span> <span class="text-xs font-bold text-gray-700">Durga Puja</span>
                            </button>
                            <button onclick="playClick(); selectType('independence')" class="col-span-2 btn-click bg-white p-3 rounded-2xl shadow-sm border border-blue-100 hover:border-blue-400 flex items-center justify-center gap-3">
                                <span class="text-2xl">üáÆüá≥</span> <span class="text-xs font-bold text-gray-700">Independence Day</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="history-section" class="mt-10 hidden-screen">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Your Creations</h3>
                        <span class="text-xs text-indigo-500 font-bold cursor-pointer hover:underline" onclick="clearHistory()">Clear All</span>
                    </div>
                    <div id="history-list" class="space-y-3 pb-20"></div>
                </div>

                <div class="mt-auto pt-8 pb-4 text-center">
                    <p class="text-[10px] text-gray-400 font-medium uppercase tracking-widest">Made with ‚ù§Ô∏è by Abhik</p>
                </div>
            </div>

            <div id="creator-form" class="fixed inset-0 bg-white/95 z-50 p-6 flex flex-col hidden-screen overflow-y-auto">
                <div class="flex items-center mb-6">
                    <button onclick="playClick(); closeForm()" class="btn-click p-3 rounded-full bg-white text-gray-600 shadow-sm hover:bg-gray-100 transition"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold ml-4 text-gray-800">Customize Wish</h2>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 mb-6 space-y-5">
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 block">Choose Aesthetic</label>
                        <div class="flex gap-4 overflow-x-auto p-2 -mx-2 scrollbar-hide" id="theme-selector"></div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 block">Gender (Optional)</label>
                        <div class="flex gap-4">
                            <label class="flex-1 cursor-pointer group" onclick="playClick()">
                                <input type="radio" name="gender" value="male" class="peer hidden" onchange="updateThemePreview('male')" checked>
                                <div class="py-3 px-4 rounded-xl border-2 border-gray-100 text-center peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 transition group-hover:border-blue-200">
                                    <span class="block text-xl mb-1">üë®</span>
                                    <span class="text-xs font-bold uppercase">Male</span>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer group" onclick="playClick()">
                                <input type="radio" name="gender" value="female" class="peer hidden" onchange="updateThemePreview('female')">
                                <div class="py-3 px-4 rounded-xl border-2 border-gray-100 text-center peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-600 transition group-hover:border-pink-200">
                                    <span class="block text-xl mb-1">üë©</span>
                                    <span class="text-xs font-bold uppercase">Female</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label id="label-name" class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-1">Who is this for?</label>
                            <input type="text" id="inp-name" placeholder="Name (e.g. Rahul)" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-gray-700 transition">
                        </div>
                        
                        <div class="flex gap-4" id="row-details">
                            <div class="w-1/3">
                                <label id="label-age" class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-1">Age</label>
                                <input type="number" id="inp-age" placeholder="25" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-gray-700 transition">
                            </div>
                            <div class="w-2/3">
                                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-1">Relation</label>
                                <select id="inp-relation" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-gray-700 transition appearance-none">
                                    <option value="friend">Friend / Bestie</option>
                                    <option value="family">Family Member</option>
                                    <option value="partner">Partner</option>
                                    <option value="colleague">Colleague</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-1">Custom Wish (Auto-Generates)</label>
                            <textarea id="inp-custom-msg" rows="3" placeholder="Type here to override..." class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500 font-medium text-gray-700 transition text-sm"></textarea>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-2">Add a Photo</label>
                        <div class="flex items-center gap-4 p-2 bg-gray-50 rounded-2xl border border-dashed border-gray-300">
                            <div class="w-14 h-14 rounded-xl bg-white shadow-sm overflow-hidden relative flex-shrink-0">
                                <img id="preview-thumb" class="w-full h-full object-cover hidden">
                                <i class="fas fa-image absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300"></i>
                            </div>
                            <label onclick="playClick()" class="flex-1 bg-white hover:bg-gray-100 text-gray-700 py-3 rounded-xl text-xs font-bold uppercase tracking-wide cursor-pointer text-center transition shadow-sm border border-gray-200">
                                <span id="photo-label-text">Choose Image</span>
                                <input type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                            </label>
                        </div>
                    </div>

                    <button onclick="playClick(); saveAndGenerate()" class="btn-click w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-5 rounded-2xl font-bold shadow-xl shadow-indigo-200 flex justify-center items-center gap-3 text-lg mt-2">
                        Create Magic <i class="fas fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </div>

            <div id="screen-reveal" class="flex-1 hidden-screen flex flex-col items-center justify-center bg-gray-900 text-white relative overflow-hidden">
                <div id="reveal-icons" class="absolute inset-0 pointer-events-none opacity-50"></div> 
                
                <div class="relative z-10 text-center px-6">
                    <p class="text-indigo-300 font-bold uppercase tracking-widest text-xs mb-4">You have a message</p>
                    <h2 class="text-4xl font-extrabold mb-12 animate-pulse leading-tight elegant-font">A Special Surprise<br>is waiting...</h2>
                    <div class="gift-box-anim text-[8rem] filter drop-shadow-2xl" onclick="playClick(); openWish()">üéÅ</div>
                    <p class="mt-12 text-xs uppercase tracking-[0.3em] text-gray-400 font-bold animate-bounce">Tap to Open</p>
                </div>
            </div>

            <div id="screen-display" class="flex-1 hidden-screen flex flex-col relative overflow-hidden transition-all duration-1000">
                
                <div id="bg-layer"></div>

                <div id="top-controls" class="absolute top-4 w-full px-4 flex justify-between z-30">
                    <button onclick="playClick(); window.location.href = window.location.pathname" class="bg-white/30 backdrop-blur-md p-2 px-4 rounded-full text-gray-800 text-xs font-bold shadow-sm border border-white/40 hover:bg-white/50 transition">
                        <i class="fas fa-home mr-1"></i> Home
                    </button>
                    <div class="flex gap-2">
                        <button id="btn-delete" onclick="playClick(); deleteWish()" class="hidden bg-red-500/80 backdrop-blur p-2 w-8 h-8 rounded-full shadow-lg text-white transition hover:scale-110">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                        <button onclick="toggleAudio()" class="bg-white/30 backdrop-blur-md p-2 w-8 h-8 rounded-full text-gray-800 border border-white/40 shadow-sm transition">
                            <i id="icon-audio" class="fas fa-volume-up text-xs"></i>
                        </button>
                    </div>
                </div>

                <div id="capture-area" class="flex-1 flex flex-col items-center justify-center p-6 text-center z-10 overflow-y-auto no-scrollbar relative">
                    
                    <div id="decorative-emojis" class="absolute inset-0 pointer-events-none z-0 overflow-hidden"></div>

                    <div class="relative mb-6 group z-10">
                        <div class="absolute inset-0 bg-white/50 rounded-full blur-xl animate-pulse group-hover:blur-2xl transition"></div>
                        <div class="photo-frame relative w-48 h-48 rounded-full p-2 bg-white/30 backdrop-blur-sm border border-white/60 shadow-2xl animate-[float_6s_infinite] mx-auto">
                            <img id="disp-img" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-inner">
                        </div>
                        
                        <div id="disp-age-badge" class="shiny-badge hidden">
                            <span id="age-text"></span>
                        </div>
                    </div>

                    <h1 id="disp-title" class="relative z-10 text-4xl font-bold text-white mb-2 drop-shadow-lg tracking-tight elegant-font leading-tight"></h1>
                    <h2 id="disp-name" class="relative z-10 text-3xl text-white/90 mb-6 handwritten drop-shadow-md transform -rotate-2"></h2>

                    <div class="glass-panel p-8 rounded-3xl shadow-2xl w-full max-w-sm relative z-10">
                        <i class="fas fa-quote-left text-indigo-400/30 text-3xl absolute -top-4 -left-2"></i>
                        <p id="disp-msg" class="text-gray-800 text-lg font-medium leading-relaxed font-serif italic"></p>
                        <i class="fas fa-quote-right text-indigo-400/30 text-3xl absolute -bottom-4 -right-2"></i>
                        
                        <div id="watermark" class="hidden mt-4 pt-4 border-t border-gray-200 text-center">
                             <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">WishMaker App</p>
                        </div>
                    </div>
                </div>

                <div id="share-sheet" class="bg-white p-5 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-20 relative transform transition w-full mt-auto">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <button onclick="playClick(); shareWhatsapp()" class="flex flex-col items-center gap-1 group">
                            <div class="w-10 h-10 bg-[#25D366] rounded-full flex items-center justify-center text-white shadow-lg group-active:scale-95 transition">
                                <i class="fab fa-whatsapp text-lg"></i>
                            </div>
                            <span class="text-[10px] font-bold text-gray-500">WhatsApp</span>
                        </button>
                        
                        <button onclick="playClick(); downloadImage()" class="flex flex-col items-center gap-1 group">
                            <div class="w-10 h-10 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 rounded-full flex items-center justify-center text-white shadow-lg group-active:scale-95 transition">
                                <i class="fab fa-instagram text-lg"></i>
                            </div>
                            <span class="text-[10px] font-bold text-gray-500">Save Img</span>
                        </button>

                        <button onclick="playClick(); copyLink()" class="flex flex-col items-center gap-1 group">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg group-active:scale-95 transition">
                                <i class="fas fa-link text-lg"></i>
                            </div>
                            <span class="text-[10px] font-bold text-gray-500">Copy Link</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION & STATE
        // ==========================================
        
        // *** IMPORTNAT: PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxLaIZ3dO1SwoGrMZsulNFMtZlGVgWaFHho2APeuZEzwyPzt9w7e_XvUsZq61qfSFHuZA/exec"; 
        
        const popAudio = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); 
        function playClick() { }

        // KEEPING SUPABASE FOR LINK SHARING FUNCTIONALITY (DB)
        const SUPABASE_URL = 'https://rhodybetonjerkcsdstj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJob2R5YmV0b25qZXJrY3Nkc3RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTU5MDAsImV4cCI6MjA4NDQ3MTkwMH0.IEO-2spCVUxYFiQW-ARlA4RH57R_DQttQsWW0tGnUMI';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentWishId = null;
        let wishData = { type: '', gender: 'male', image: null, theme: null }; 
        let userModifiedText = false;

        const themes = [
            { id: 'theme-blue', img: 'https://images.unsplash.com/photo-1506765515384-028b60a970df?auto=format&fit=crop&w=800&q=80', name: 'Blue', mood: 'refreshing' },
            { id: 'theme-pink', img: 'https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?auto=format&fit=crop&w=800&q=80', name: 'Pink', mood: 'sweet' },
            { id: 'theme-purple', img: 'https://images.unsplash.com/photo-1563089145-599997674d42?auto=format&fit=crop&w=800&q=80', name: 'Purple', mood: 'magical' },
            { id: 'theme-sunset', img: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=80', name: 'Sunset', mood: 'warm' },
            { id: 'theme-mint', img: 'https://images.unsplash.com/photo-1618130070080-91f4d55a2383?auto=format&fit=crop&w=800&q=80', name: 'Nature', mood: 'fresh' },
            { id: 'theme-gold', img: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&w=800&q=80', name: 'Luxury', mood: 'golden' },
            { id: 'theme-dark', img: 'https://images.unsplash.com/photo-1483729558449-99ef09a8c325?auto=format&fit=crop&w=800&q=80', name: 'Dark', mood: 'starry' },
            { id: 'theme-ocean', img: 'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?auto=format&fit=crop&w=800&q=80', name: 'Ocean', mood: 'peaceful' },
            { id: 'theme-berry', img: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7?auto=format&fit=crop&w=800&q=80', name: 'Love', mood: 'lovely' },
            { id: 'theme-royal', img: 'https://images.unsplash.com/photo-1535868463750-c78d9543614f?auto=format&fit=crop&w=800&q=80', name: 'Classic', mood: 'timeless' },
            { id: 'theme-holi', img: 'https://images.unsplash.com/photo-1552084117-5633b4c1945f?auto=format&fit=crop&w=800&q=80', name: 'Holi', mood: 'colorful' },
            { id: 'theme-diwali', img: 'https://images.unsplash.com/photo-1571556270929-e3144d2847be?auto=format&fit=crop&w=800&q=80', name: 'Diwali', mood: 'bright' }
        ];

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            setupThemeSelector();
            
            ['inp-name', 'inp-age', 'inp-relation'].forEach(id => {
                document.getElementById(id).addEventListener('input', generateLiveText);
            });
            document.querySelectorAll('input[name="gender"]').forEach(el => {
                el.addEventListener('change', (e) => {
                    updateThemePreview(e.target.value);
                    generateLiveText();
                });
            });
            document.getElementById('inp-custom-msg').addEventListener('input', () => {
                userModifiedText = true;
            });

            if (id) {
                document.getElementById('screen-home').classList.add('hidden-screen');
                document.getElementById('screen-loading').classList.remove('hidden-screen');
                await fetchAndLoadWish(id);
            } else {
                setTimeout(() => { startGhostLoop(); }, 10000);
                loadHistory(); 
            }
        };

        // DYNAMIC WISH LOGIC
        function generateLiveText() {
            if (userModifiedText) return; 

            const name = document.getElementById('inp-name').value.trim() || 'Dear';
            const ageVal = document.getElementById('inp-age').value;
            const relation = document.getElementById('inp-relation').value;
            const type = wishData.type;
            const themeObj = themes.find(t => t.id === wishData.theme) || themes[0];
            const mood = themeObj.mood;

            let msg = "";
            let ageGroup = 'adult';
            if (ageVal && parseInt(ageVal) < 13) ageGroup = 'child';

            // FESTIVAL & EVENT LOGIC
            if (type === 'birthday') {
                if (ageGroup === 'child') msg = `Happy Birthday little star ${name}! üéà‚ú® May your day be as colorful as this ${mood} card!`;
                else msg = `Happy Birthday ${name}! üéÇ Wishing you a fantastic year filled with ${mood} vibes and success.`;
            } else if (type === 'wedding') {
                msg = `Happy Anniversary ${name}! üíç Celebrating your beautiful journey. Stay blessed and happy forever.`;
            } else if (type === 'diwali') {
                msg = `Happy Diwali ${name}! ü™î May the lamps of joy illuminate your life with good health and wealth.`;
            } else if (type === 'holi') {
                msg = `Happy Holi ${name}! üé® May your life be as colorful and joyful as this festival. Have a blast!`;
            } else if (type === 'ganesha') {
                msg = `Happy Ganesh Chaturthi ${name}! üêò May Lord Ganesha remove all obstacles and bless you.`;
            } else if (type === 'durga') {
                msg = `Happy Durga Puja ${name}! üî± May Maa Durga empower you with strength and happiness.`;
            } else if (type === 'independence') {
                msg = `Happy Independence Day ${name}! üáÆüá≥ Saluting the spirit of India. Jai Hind!`;
            }

            document.getElementById('inp-custom-msg').value = msg;
        }
        
        function startGhostLoop() {
            function runSequence() {
                const cursor = document.getElementById('ghost-cursor');
                const title = document.getElementById('app-title');
                const homeScreen = document.getElementById('screen-home');
                const matrixOverlay = document.getElementById('matrix-overlay');
                const creatorForm = document.getElementById('creator-form');
                
                if(cursor && title && 
                   !homeScreen.classList.contains('hidden-screen') && 
                   matrixOverlay.classList.contains('hidden-screen') &&
                   creatorForm.classList.contains('hidden-screen')) {
                    
                    cursor.classList.remove('anim-move-click');
                    title.classList.remove('anim-text-bump');
                    void cursor.offsetWidth; 
                    cursor.style.display = 'block';
                    cursor.classList.add('anim-move-click');
                    title.classList.add('anim-text-bump');
                    spawnRipples();
                } else {
                    cursor.style.display = 'none';
                }
            }
            runSequence();
            setInterval(runSequence, 10000);
        }

        function spawnRipples() {
            setTimeout(() => createRipple(), 1125);
            setTimeout(() => createRipple(), 1800);
            setTimeout(() => createRipple(), 2475);
            setTimeout(() => createRipple(), 3150);
        }

        function createRipple() {
            const title = document.getElementById('app-title');
            if(!title) return;
            const targetSpan = title.querySelector('span');
            let x, y;
            if (targetSpan) {
                const rect = targetSpan.getBoundingClientRect();
                x = rect.left + 8;
                y = rect.top + (rect.height / 2);
            } else {
                const rect = title.getBoundingClientRect();
                x = rect.left + rect.width / 2;
                y = rect.top + rect.height / 2;
            }
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        let titleTapCount = 0; let tapTimer;

        function triggerEasterEgg() {
            const title = document.getElementById('app-title');
            title.classList.remove('anim-text-bump');
            title.classList.remove('manual-bump');
            void title.offsetWidth; 
            title.classList.add('manual-bump');

            titleTapCount++;
            clearTimeout(tapTimer);
            tapTimer = setTimeout(() => { titleTapCount = 0; }, 2000);

            if (titleTapCount === 4) {
                activateMatrix();
                titleTapCount = 0;
            }
        }

        function activateMatrix() {
            document.getElementById('matrix-overlay').classList.remove('hidden-screen');
            document.getElementById('ghost-cursor').style.display = 'none'; 
            document.getElementById('matrix-controls').style.opacity = '0'; 
            startMatrixRain();
            setTimeout(() => { document.getElementById('matrix-controls').style.opacity = '1'; }, 4000);
        }

        function exitMatrix() { 
             document.getElementById('matrix-overlay').classList.add('hidden-screen');
        }

        function startMatrixRain() {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const katakana = '01'; const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; const nums = '0123456789'; const alphabet = katakana + latin + nums;
            const fontSize = 16; const columns = canvas.width / fontSize; const rainDrops = [];
            for (let x = 0; x < columns; x++) { rainDrops[x] = 1; }
            const draw = () => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#0F0'; ctx.font = fontSize + 'px monospace';
                for (let i = 0; i < rainDrops.length; i++) {
                    const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                    if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) { rainDrops[i] = 0; }
                    rainDrops[i]++;
                }
            }; setInterval(draw, 30);
        }

        function setupThemeSelector() {
            const container = document.getElementById('theme-selector');
            container.innerHTML = '';
            themes.forEach(t => {
                const div = document.createElement('div');
                div.className = `theme-option`;
                div.style.backgroundImage = `url(${t.img})`;
                div.onclick = () => {
                    document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    wishData.theme = t.id; 
                    playClick();
                    generateLiveText(); 
                };
                container.appendChild(div);
            });
        }

        function selectType(type) {
            wishData.type = type;
            document.getElementById('screen-home').classList.add('hidden-screen'); 
            document.getElementById('creator-form').classList.remove('hidden-screen');
            document.getElementById('ghost-cursor').style.display = 'none';
            
            const ageLabel = document.getElementById('label-age');
            const rowDetails = document.getElementById('row-details');
            
            // Adjust UI based on type
            if(type === 'wedding') { ageLabel.innerText = "Years"; rowDetails.style.display = 'flex'; }
            else if (['diwali','holi','ganesha','durga','independence'].includes(type)) {
                rowDetails.style.display = 'none'; // Hide age/relation for festivals
            } else { 
                ageLabel.innerText = "Age"; 
                rowDetails.style.display = 'flex'; 
            }
            
            generateLiveText(); 
        }

        function closeForm() {
            document.getElementById('creator-form').classList.add('hidden-screen'); 
            document.getElementById('screen-home').classList.remove('hidden-screen'); 
        }

        function updateThemePreview(gender) { wishData.gender = gender; }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    wishData.image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-thumb').src = wishData.image;
                    document.getElementById('preview-thumb').classList.remove('hidden');
                    document.getElementById('photo-label-text').innerText = "Changed";
                };
            };
            reader.readAsDataURL(file);
        }

        async function saveAndGenerate() {
            const name = document.getElementById('inp-name').value;
            const age = document.getElementById('inp-age').value || 0;
            const customMsg = document.getElementById('inp-custom-msg').value;
            
            if(!name) return alert("Please enter a name!");
            
            let msg = customMsg.trim();
            if(!msg) msg = `Happy ${wishData.type}`;
            
            let finalTheme = wishData.theme;
            if(!finalTheme) { finalTheme = getSmartTheme(wishData.type, age, wishData.gender); }
            
            document.getElementById('screen-loading').classList.remove('hidden-screen');

            // 1. SAVE TO GOOGLE SHEET (If configured)
            // We use no-cors to prevent errors, even though we can't read the response.
            if(GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                try {
                    const formData = new FormData();
                    formData.append('type', wishData.type);
                    formData.append('name', name);
                    formData.append('message', msg);
                    formData.append('date', new Date().toLocaleString());
                    
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors' 
                    }).then(() => console.log("Sent to Google Sheet"));
                } catch (e) { console.error("Sheet Error", e); }
            }

            // 2. SAVE TO SUPABASE (For Link Generation)
            const { data, error } = await client.from('wishes').insert([{ 
                type: wishData.type, name: name, message: msg, 
                image_data: wishData.image, 
                gender: wishData.gender, age: age, theme: finalTheme
            }]).select();

            if(error) {
                console.error(error);
                alert("Error saving! Check connection.");
                document.getElementById('screen-loading').classList.add('hidden-screen');
                return;
            }

            const newId = data[0].id;
            addToHistory(newId, name, wishData.type);
            window.location.href = `?id=${newId}`;
        }

        function getSmartTheme(type, age, gender) {
            const pools = {
                wedding: ['theme-gold', 'theme-berry', 'theme-royal', 'theme-purple'],
                child_male: ['theme-blue', 'theme-mint', 'theme-ocean'],
                child_female: ['theme-pink', 'theme-purple', 'theme-sunset'],
                diwali: ['theme-diwali', 'theme-gold', 'theme-sunset'],
                holi: ['theme-holi', 'theme-pink', 'theme-blue'],
                ganesha: ['theme-gold', 'theme-orange'],
                durga: ['theme-red', 'theme-gold'],
                independence: ['theme-mint', 'theme-blue'],
                default: ['theme-blue', 'theme-mint', 'theme-sunset']
            };
            
            if (type === 'diwali') return pools.diwali[0];
            if (type === 'holi') return pools.holi[0];
            if (type === 'wedding') return pools.wedding[0];
            
            return pools.default[0];
        }

        async function fetchAndLoadWish(id) {
            currentWishId = id;
            const { data, error } = await client.from('wishes').select('*').eq('id', id).single();
            if(error || !data) { removeFromHistory(id); alert("Wish not found!"); window.location.href = window.location.pathname; return; }
            
            const defaultAvatar = data.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png';
            document.getElementById('disp-img').src = data.image_data || defaultAvatar;
            
            // Set Title based on Type
            let title = "Best Wishes!";
            if(data.type === 'birthday') title = "Happy Birthday!";
            else if(data.type === 'wedding') title = "Happy Anniversary!";
            else if(data.type === 'diwali') title = "Happy Diwali!";
            else if(data.type === 'holi') title = "Happy Holi!";
            else if(data.type === 'ganesha') title = "Happy Ganesh Chaturthi!";
            else if(data.type === 'durga') title = "Happy Durga Puja!";
            else if(data.type === 'independence') title = "Jai Hind!";
            
            document.getElementById('disp-title').innerText = title;
            document.getElementById('disp-name').innerText = data.name;
            document.getElementById('disp-msg').innerText = data.message;
            
            const themeObj = themes.find(t => t.id === data.theme) || themes[0];
            document.getElementById('bg-layer').style.backgroundImage = `url(${themeObj.img})`;

            if(data.age && data.age > 0) {
                const badge = document.getElementById('disp-age-badge');
                document.getElementById('age-text').innerText = data.age;
                badge.classList.remove('hidden');
            }
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            if(history.some(item => item.id === id)) { document.getElementById('btn-delete').classList.remove('hidden'); }
            
            document.getElementById('audio-bg').src = 'happy-birthday.mp3'; // You can add logic to switch MP3 based on type
            setupFloatingIcons(data.age, data.gender, data.type);
            setupDecorativeEmojis(data.type, data.gender); 
            document.getElementById('screen-loading').classList.add('hidden-screen');
            document.getElementById('screen-reveal').classList.remove('hidden-screen');
        }

        function openWish() {
            document.getElementById('screen-reveal').classList.add('hidden-screen');
            document.getElementById('screen-display').classList.remove('hidden-screen');
            document.getElementById('audio-bg').play().catch(e => console.log("Tap for audio"));
            fireConfetti();
        }

        function setupDecorativeEmojis(type, gender) {
            const container = document.getElementById('decorative-emojis');
            container.innerHTML = '';
            let emojis = ['‚ú®', 'üéà', 'üéâ'];
            if (type === 'birthday') { emojis = gender === 'female' ? ['ü¶ã', 'üå∏', 'üßÅ', '‚ú®'] : ['üî•', 'üöÄ', 'üé∏', '‚ö°']; } 
            else if (type === 'diwali') { emojis = ['ü™î', '‚ú®', 'üéá']; }
            else if (type === 'holi') { emojis = ['üé®', 'üíß', 'üåà']; }
            
            const positions = [ { top: '10%', left: '10%' }, { top: '15%', right: '10%' }, { bottom: '35%', left: '5%' }, { bottom: '40%', right: '5%' } ];
            positions.forEach((pos, index) => {
                const el = document.createElement('div');
                el.className = 'deco-emoji';
                el.innerText = emojis[index % emojis.length];
                Object.assign(el.style, pos);
                el.style.animationDelay = `${index * 0.5}s`;
                container.appendChild(el);
            });
        }

        function downloadImage() {
            const screen = document.getElementById('screen-display');
            const topControls = document.getElementById('top-controls');
            const shareSheet = document.getElementById('share-sheet');
            const watermark = document.getElementById('watermark');
            topControls.style.display = 'none'; shareSheet.style.display = 'none'; watermark.style.display = 'block'; 
            html2canvas(screen, { scale: 3, useCORS: true, allowTaint: true, backgroundColor: null, width: screen.offsetWidth, height: screen.offsetHeight }).then(canvas => {
                topControls.style.display = 'flex'; shareSheet.style.display = 'block'; watermark.style.display = 'none';
                const link = document.createElement('a');
                link.download = `Wish_${document.getElementById('disp-name').innerText}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                alert("Image Saved! üì∏");
            });
        }

        function shareWhatsapp() {
            const name = document.getElementById('disp-name').innerText;
            const text = `Hey ${name}, I made a special wish for you! ‚ú® Tap to see: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => alert("Wish + Link Copied! üìã"));
        }

        function deleteWish() {
            if(!confirm("Delete forever?")) return;
            client.from('wishes').delete().eq('id', currentWishId).then(() => {
                removeFromHistory(currentWishId);
                window.location.href = window.location.pathname;
            });
        }

        function addToHistory(id, name, type) {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            history.unshift({ id, name, type, date: new Date().toLocaleDateString() });
            localStorage.setItem('wish_history', JSON.stringify(history));
        }
        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            const list = document.getElementById('history-list');
            const section = document.getElementById('history-section');
            if (history.length === 0) { section.classList.add('hidden-screen'); return; }
            section.classList.remove('hidden-screen');
            list.innerHTML = '';
            history.forEach(item => {
                const icon = item.type === 'birthday' ? 'üéÇ' : '‚ú®';
                const fullUrl = `${window.location.origin}${window.location.pathname}?id=${item.id}`;
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm hover:shadow-md transition';
                div.innerHTML = `
                    <div class="flex items-center gap-3"><span class="text-xl bg-gray-50 p-2 rounded-lg">${icon}</span><div><p class="font-bold text-gray-800 text-sm">${item.name}</p><p class="text-[10px] text-gray-400">${item.date}</p></div></div>
                    <div class="flex gap-2"><button onclick="navigator.clipboard.writeText('${fullUrl}').then(()=>alert('Link Copied!'))" class="bg-gray-100 text-gray-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-200 transition"><i class="fas fa-copy text-xs"></i></button><a href="?id=${item.id}" class="bg-indigo-50 text-indigo-600 text-xs font-bold px-3 py-2 rounded-lg hover:bg-indigo-100 flex items-center">View</a></div>
                `;
                list.appendChild(div);
            });
        }
        function removeFromHistory(id) {
            let history = JSON.parse(localStorage.getItem('wish_history') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('wish_history', JSON.stringify(history));
        }
        function clearHistory() { if(confirm("Clear history list?")) { localStorage.removeItem('wish_history'); location.reload(); } }

        function setupFloatingIcons(age, gender, type) {
            const container = document.getElementById('reveal-icons');
            let icons = ['‚ú®', 'üéÅ']; 
            if(type === 'birthday') icons = ['üéà', 'üéÇ', 'ü•≥'];
            else if(type === 'diwali') icons = ['ü™î', '‚ú®', 'üéá'];
            
            container.innerHTML = '';
            for(let i=0; i<20; i++) {
                const el = document.createElement('div');
                el.innerText = icons[Math.floor(Math.random()*icons.length)];
                el.style.position = 'absolute';
                el.style.left = Math.random() * 100 + '%';
                el.style.top = Math.random() * 100 + '%';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animation = `float ${Math.random()*3 + 2}s infinite ease-in-out`;
                container.appendChild(el);
            }
        }
        function fireConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); }
        function toggleAudio() {
            const audio = document.getElementById('audio-bg');
            const icon = document.getElementById('icon-audio');
            if(audio.paused) { audio.play(); icon.className = "fas fa-volume-up text-xs"; icon.parentElement.classList.remove("text-red-500", "border-red-500"); } 
            else { audio.pause(); icon.className = "fas fa-volume-mute text-xs"; icon.parentElement.classList.add("text-red-500", "border-red-500"); }
        }
    </script>
</body>
</html>
